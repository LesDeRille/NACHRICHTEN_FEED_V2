<!DOCTYPE html>
<html>

<head>
    <title>Tagesschau</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <!-- weitere Kopfinformationen -->
    <!-- Kommentare werden im Browser nicht angezeigt. -->
</head>

<style>
    a {
        color: #0060B6;
        text-decoration: none;
        font-weight: bold;
        font-size: 120%;
    }
</style>

<body>
    <h2>Tagesschau</h2>
    <h3>Sport</h3>

    <div id="ressorts">
    </div>
    <dl id="Schlagzeilen">
        <!-- <dt>Beast of Bodmin</dt>
        <dd>A large feline inhabiting Bodmin Moor.</dd> -->
    </dl>

    <!-- Dialog muß ich nachher übernehmen -->
    <dialog id="tagDialog">
        <p>Tag <em id="derTag"></em> auf Blacklist?</p>
        <p><input type="submit" value="OK" id="tagAufBlacklist"></p>
    </dialog>
    <!-- Ende Dialog muß ich nachher übernehmen -->
    <script>

        async function urlLesen(ressort = "Sport") {
            let url = 'https://www.tagesschau.de/api2u/news/?ressort=' + ressort;
            let response = await fetch(url);
            let commits = await response.json(); // read response body and parse as JSON


            meldungenVerarbeiten(commits.news)
        }


        function meldungenVerarbeiten(inhalt) {
            inhalt.sort((a, b) => new Date(b.date) - new Date(a.date))
            for (meldung of inhalt) {
                neueSchlagzeileErzeugen(meldung);
            }
        }

        tagAufBlacklist.addEventListener("click", () => {
            console.log(blacklist)
            blacklist.push(gewaehlterTag.textContent);
            console.log(blacklist)
            tagDialog.close();
        });

        let gewaehlterTag = document.getElementById("derTag");


        function neueSchlagzeileErzeugen(meldung) {
            let inBlacklist = false;

            function meldungNichtAufBlacklist() {
                let schlagzeilen = document.getElementById("Schlagzeilen");
                let neuerTitel = document.createElement("dt");
                let neueErsteZeile = document.createElement("dd");
                let neuerAnker = document.createElement("a");
                let leerzeile = document.createElement("hr");
                let datum = document.createElement("span");
                let alleTags = document.createElement("button");

                neueErsteZeile.textContent = meldung.firstSentence;
                neuerAnker.href = meldung.detailsweb;
                datum.textContent = "   " + (new Date(meldung.date)).toLocaleString();
                neuerAnker.textContent = meldung.title;

                neuerTitel.appendChild(neuerAnker);
                neuerTitel.appendChild(datum);
                // Hauptteil zum nachher ins Hauptprogramm reinkopieren

                for (i of taggis) {
                    let tagButton = document.createElement("button");
                    tagButton.textContent = i;
                    neuerTitel.appendChild(tagButton);

                    tagButton.oncontextmenu = function (event) {
                        event.preventDefault();
                        gewaehlterTag.textContent = tagButton.textContent;
                        tagDialog.showModal();
                    }
                }
                // Ende Hauptteil zum nachher ins Hauptprogramm reinkopieren

                schlagzeilen.appendChild(neuerTitel);
                schlagzeilen.appendChild(neueErsteZeile);
                schlagzeilen.appendChild(leerzeile);
                // Datum
                let titelzeilen = document.getElementsByTagName("dt");
                let letzte = titelzeilen.length - 1;

                let grenze = new Date(letzterAufrufDesRessorts);
                let meldeDate = new Date(meldung.date);
                if (meldeDate < grenze) {
                    titelzeilen[letzte].setAttribute("style", "background-color: gainsboro");
                } else {
                    titelzeilen[letzte].setAttribute("style", "background-color: white");
                }
            };


            let taggis = meldung.tags.map(x => x.tag);
            let tagString = taggis.toString();

            for (item of meldung.tags) {
                if (blacklist.includes(item.tag)) {
                    inBlacklist = true;
                }
            }
            if (!inBlacklist) meldungNichtAufBlacklist();
        }

        function buttonsErzeugen() {
            let gewaehltesRessort = document.getElementsByTagName("h3");
            //let ressorts = ["Inland", "Ausland", "Wirtschaft", "Sport", "Wissen", "Investigativ"];
            let knopfPosition = document.getElementById("ressorts");

            function bisherigeSchlagzeilenLoeschen() {
                const schlag = document.getElementById("Schlagzeilen");
                while (schlag.firstChild) {
                    schlag.removeChild(schlag.firstChild);
                }
            }

            for (ressort of ressorts) {
                let knopf = document.createElement("button");
                knopf.textContent = ressort
                knopfPosition.appendChild(knopf)
                knopf.addEventListener("click", () => {
                    let ressortDatum = JSON.parse(localStorage.getItem("Ressortaufrufe"));
                    letzterAufrufDesRessorts = ressortDatum[knopf.textContent];
                    // Aktualisierung des Aufrufdatums des aktuellen Ressorts
                    ressortDatum[knopf.textContent] = Date();
                    let werte = JSON.stringify(ressortDatum);
                    localStorage.setItem("Ressortaufrufe", JSON.stringify(ressortDatum));

                    gewaehltesRessort[0].textContent = knopf.textContent
                    bisherigeSchlagzeilenLoeschen();
                    urlLesen(knopf.textContent);
                })
            }
        }


        // Programmsteuerung
        // let defaultRessort = "sport"

        let letzterAufrufDesRessorts;
        let ressorts = ["Inland", "Ausland", "Wirtschaft", "Sport", "Wissen", "Investigativ"];
        const letzteAufrufe = JSON.parse(localStorage.getItem("Ressortaufrufe"));
        let blacklist = ["Fußball"];

        try {
            Object.keys(letzteAufrufe).length > 0;
            weiterImNormalenModus();
        }
        catch {
            // Es sind keine Daten da. Oder Du bist im privaten Modus");
            weiterImPrivatenModus();
        }

        function weiterImNormalenModus() {
            letzterAufrufDesRessorts = letzteAufrufe["Sport"]
        }

        function weiterImPrivatenModus() {
            // Wenn noch keineDaten auf localStorage stehen, weil das Programm zum ersten Mal gestartet wird,
            // oder weil Safari im privaten Modus nicht aus localStorage lesen kann,
            // werden hier für jedes Ressort Startdaten erstellt
            const startdatum = new Date("1970-01-01");
            // let ressorts = ["Inland", "Ausland", "Wirtschaft", "Sport", "Wissen", "Investigativ"];
            let ressortDatum = {};
            for (ressort of ressorts) {
                ressortDatum[ressort] = startdatum;
                let werte = JSON.stringify(ressortDatum);
                localStorage.setItem("Ressortaufrufe", JSON.stringify(ressortDatum));
            }
            letzterAufrufDesRessorts = startdatum;
        }

        urlLesen();
        buttonsErzeugen();

    </script>
</body>

</html>